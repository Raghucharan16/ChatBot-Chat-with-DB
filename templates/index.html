<!DOCTYPE html>
<html>
<head>
  <title>Vanna SQL Chatbot</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px auto;
      max-width: 600px;
    }
    .chat-container {
      margin-top: 20px;
    }
    .user-message, .bot-message {
      padding: 10px;
      margin-top: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    .user-message {
      background-color: #f0f9ff;
    }
    .bot-message {
      background-color: #f9f9f9;
    }
    pre.sql {
      background: #f3f3f3;
      padding: 5px;
      border-radius: 5px;
      overflow: auto;
    }
  </style>
</head>
<body>

<h1>FreshBus Internal Chatbot</h1>
<p>Ask a question and Chatbot will generate SQL and run it on the database.</p>

<div>
  <input type="text" id="questionInput" placeholder="Enter your question..." style="width: 80%;">
  <button id="askBtn">Ask</button>
</div>

<div id="chat" class="chat-container"></div>

<script>
  const questionInput = document.getElementById("questionInput");
  const askBtn = document.getElementById("askBtn");
  const chatContainer = document.getElementById("chat");

  askBtn.addEventListener("click", async () => {
    const question = questionInput.value.trim();
    if (!question) return;

    // Display user's message
    const userDiv = document.createElement("div");
    userDiv.className = "user-message";
    userDiv.innerHTML = `<strong>You:</strong> ${question}`;
    chatContainer.appendChild(userDiv);

    questionInput.value = "";

    // Call /ask endpoint
    try {
      const response = await fetch("/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question })
      });
      if (!response.ok) {
        throw new Error(`Request failed: ${response.status}`);
      }
      const data = await response.json();

      // Display the SQL
      const botDivSQL = document.createElement("div");
      botDivSQL.className = "bot-message";
      botDivSQL.innerHTML = `
        <strong>Bot (SQL):</strong>
        <pre class="sql">${(data.sql || "No SQL generated").replace(/</g, "&lt;")}</pre>
      `;
      chatContainer.appendChild(botDivSQL);

      // Display the answer or explanation
      const botDivAns = document.createElement("div");
      botDivAns.className = "bot-message";
      botDivAns.innerHTML = `
        <strong>Bot (Answer):</strong> ${data.answer || "No answer returned"}
      `;
      chatContainer.appendChild(botDivAns);

      // Display rows if any
      if (data.rows && data.rows.length > 0) {
        const rowsDiv = document.createElement("div");
        rowsDiv.className = "bot-message";
        rowsDiv.innerHTML = "<strong>Rows:</strong><br>" + JSON.stringify(data.rows, null, 2);
        chatContainer.appendChild(rowsDiv);
      }

    } catch (error) {
      const errorDiv = document.createElement("div");
      errorDiv.className = "bot-message";
      errorDiv.style.color = "red";
      errorDiv.innerHTML = `<strong>Error:</strong> ${error}`;
      chatContainer.appendChild(errorDiv);
    }
  });
</script>

</body>
</html>
